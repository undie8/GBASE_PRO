<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sci Shop POS Pro - 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .card-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: 0.3s; }
    .hide { display: none !important; }
    .tab-active { border-bottom: 4px solid #6366f1; color: #6366f1; font-weight: bold; }
    .admin-tab-active { background-color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); color: #6366f1; }
  </style>
</head>

<body class="h-full gradient-bg overflow-hidden" onload="checkSession()">
  <div id="app" class="h-full overflow-auto text-gray-800 pb-10">
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <div id="auth-page" class="min-h-full flex items-center justify-center p-4">
      <div class="card-glass rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-6">
            <span class="text-6xl">üî¨</span>
            <h1 class="text-3xl font-bold mt-2">Sci Shop</h1>
        </div>
        <div class="flex mb-6 bg-gray-100 rounded-xl p-1">
          <button onclick="switchAuth('login')" id="tab-l" class="flex-1 py-2 rounded-lg font-bold bg-white shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button onclick="switchAuth('reg')" id="tab-r" class="flex-1 py-2 rounded-lg font-bold text-gray-400">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
        </div>
        
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
          <input type="text" id="l-user" required class="w-full p-3 rounded-xl border outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
          <input type="password" id="l-pass" required class="w-full p-3 rounded-xl border outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
          <button type="submit" id="login-btn" class="w-full btn-primary text-white py-3 rounded-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>

        <form id="reg-form" onsubmit="handleRegister(event)" class="space-y-4 hide">
          <input type="text" id="r-user" required class="w-full p-3 rounded-xl border outline-none" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
          <input type="password" id="r-pass" required class="w-full p-3 rounded-xl border outline-none" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
          <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
        </form>
      </div>
    </div>

    <div id="shop-page" class="hide min-h-full flex flex-col">
      <header class="bg-white shadow-sm sticky top-0 z-40 px-4 py-2">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
          <div class="flex items-center gap-2"><span class="text-3xl">üß™</span><h1 class="font-bold text-xl hidden sm:block">Sci Shop POS</h1></div>
          <nav class="flex gap-6 mx-4">
              <button onclick="switchMainTab('shop')" id="m-tab-shop" class="py-3 px-2 tab-active transition-all">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
              <button onclick="switchMainTab('profile')" id="m-tab-profile" class="py-3 px-2 text-gray-400 transition-all">üë§ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
              <button onclick="switchMainTab('admin')" id="m-tab-admin" class="py-3 px-2 text-gray-400 hide transition-all">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</button>
          </nav>
          <div class="flex items-center gap-3">
            <div class="bg-green-50 px-3 py-1 rounded-full border border-green-200"><span class="text-green-600 font-bold">‡∏ø <span id="balance-display">0</span></span></div>
            <button onclick="toggleCart()" class="relative p-2 bg-pink-50 rounded-full">üõí <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span></button>
            <button onclick="logout()" class="p-2 hover:bg-gray-100 rounded-full">üö™</button>
          </div>
        </div>
      </header>

      <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6 overflow-auto">
        <section id="view-shop" class="space-y-6">
            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </section>
        <section id="view-profile" class="hide space-y-4">
            <h2 class="text-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <div id="user-history-list" class="space-y-2"></div>
        </section>
        <section id="view-admin" class="hide">
            <p>Admin Dashboard Loading...</p>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = "https://script.google.com/macros/s/AKfycbymqDsDwWSayPwsGogUwGxxOvobyvCikp_guq6-B2t2oieilor6p3ETeTatOQYk8Psx/exec";
    let dbUsers = [], products = [], history = [], currentUser = null, cart = [], isReady = false;

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
    function checkSession() {
        const saved = localStorage.getItem('sciShopUser');
        if(saved) {
            currentUser = JSON.parse(saved);
            initShop();
        }
        fetchData();
    }

    // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ---
    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            dbUsers = data.users; products = data.products; history = data.history;
            isReady = true;
            if(currentUser) refreshUserData();
            renderProducts();
        } catch (e) { console.error(e); }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login/Register (‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô‡∏£‡∏π‡∏õ) ---
    function switchAuth(m) {
      document.getElementById('login-form').classList.toggle('hide', m==='reg');
      document.getElementById('reg-form').classList.toggle('hide', m==='login');
      document.getElementById('tab-l').className = m==='login'?'flex-1 py-2 rounded-lg font-bold bg-white shadow':'flex-1 py-2 rounded-lg font-bold text-gray-400';
      document.getElementById('tab-r').className = m==='reg'?'flex-1 py-2 rounded-lg font-bold bg-white shadow':'flex-1 py-2 rounded-lg font-bold text-gray-400';
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
    async function handleLogin(e) {
      e.preventDefault();
      if(!isReady) return showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "error");
      const uInput = document.getElementById('l-user').value.trim();
      const pInput = document.getElementById('l-pass').value.trim();
      const user = dbUsers.find(x => String(x.username) === uInput && String(x.password) === pInput);
      
      if (user) { 
          currentUser = user; 
          localStorage.setItem('sciShopUser', JSON.stringify(user));
          initShop(); 
      } else { 
          showToast("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
      }
    }

    function initShop() {
      document.getElementById('auth-page').classList.add('hide');
      document.getElementById('shop-page').classList.remove('hide');
      if(currentUser.role === 'admin') document.getElementById('m-tab-admin').classList.remove('hide');
      refreshUserData();
    }

    function refreshUserData() {
        const u = dbUsers.find(x => x.username === currentUser.username);
        if(u) { 
            currentUser = u; 
            document.getElementById('balance-display').innerText = u.balance.toLocaleString();
        }
    }

    function renderProducts() {
      document.getElementById('product-grid').innerHTML = products.map(p => `
        <div class="card-glass rounded-2xl p-4 text-center shadow hover:scale-105 transition-all">
          <div class="text-4xl mb-2">${p.icon}</div>
          <div class="font-bold text-sm truncate">${p.name}</div>
          <div class="text-pink-600 font-bold mb-2">${p.price} ‡∏ø</div>
          <button onclick="addToCart(${p.id})" class="w-full bg-gray-800 text-white py-1 rounded-lg text-xs font-bold">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
        </div>`).join('');
    }

    function showToast(m, type="success") {
      const c = document.getElementById('toast-container');
      const d = document.createElement('div');
      d.className = `px-6 py-3 rounded-xl shadow-lg text-white font-bold ${type==='success'?'bg-green-500':'bg-red-500'}`;
      d.innerText = m; c.appendChild(d); setTimeout(()=>d.remove(), 3000);
    }

    function logout() {
        localStorage.removeItem('sciShopUser');
        location.reload();
    }

    function switchMainTab(tab) {
        ['shop', 'profile', 'admin'].forEach(t => {
            document.getElementById(`view-${t}`).classList.add('hide');
            document.getElementById(`m-tab-${t}`).classList.remove('tab-active');
            document.getElementById(`m-tab-${t}`).classList.add('text-gray-400');
        });
        document.getElementById(`view-${tab}`).classList.remove('hide');
        document.getElementById(`m-tab-${tab}`).classList.add('tab-active');
        document.getElementById(`m-tab-${tab}`).classList.remove('text-gray-400');
    }
  </script>
</body>
</html>