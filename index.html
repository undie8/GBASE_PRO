<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sci Shop POS - Pro Edition 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .card-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
    .hide { display: none !important; }
    .tab-active { border-bottom: 3px solid #6366f1; color: #6366f1; font-weight: bold; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast { animation: slideIn 0.3s ease forwards; }
  </style>
</head>

<body class="h-full gradient-bg overflow-hidden" onload="checkSession()">
  <div id="app" class="h-full overflow-auto text-gray-800 pb-10">
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <div id="auth-page" class="min-h-full flex items-center justify-center p-4">
      <div class="card-glass rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-6"><span class="text-6xl">üî¨</span><h1 class="text-3xl font-bold mt-2">Sci Shop</h1><p class="text-gray-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p></div>
        <div class="flex mb-6 bg-gray-100 rounded-xl p-1">
          <button onclick="switchAuth('login')" id="tab-l" class="flex-1 py-2 rounded-lg font-bold bg-white shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button onclick="switchAuth('reg')" id="tab-r" class="flex-1 py-2 rounded-lg font-bold text-gray-400">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
        </div>
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
          <input type="text" id="l-user" required class="w-full p-3 rounded-xl border outline-none focus:ring-2 ring-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
          <input type="password" id="l-pass" required class="w-full p-3 rounded-xl border outline-none focus:ring-2 ring-indigo-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
          <button type="submit" id="login-btn" class="w-full btn-primary text-white py-3 rounded-xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        </div>
    </div>

    <div id="shop-page" class="hide min-h-full">
      <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
          <div class="flex items-center gap-2"><span class="text-3xl">üß™</span><h1 class="font-bold text-xl hidden md:block">Sci Shop POS</h1></div>
          
          <div class="flex-1 max-w-md mx-4">
            <input type="text" id="search-input" oninput="renderProducts()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="w-full px-4 py-2 rounded-full border bg-gray-50 focus:outline-none focus:ring-2 ring-indigo-300">
          </div>

          <div class="flex items-center gap-3">
            <div class="bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                <span class="text-indigo-600 font-bold">‡∏ø <span id="balance-display">0</span></span>
            </div>
            <button onclick="toggleCart()" class="relative p-2 bg-pink-50 rounded-full hover:bg-pink-100 transition-colors">
                üõí <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
            </button>
            <button onclick="logout()" class="p-2 hover:bg-red-50 rounded-full" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">üö™</button>
          </div>
        </div>
      </header>

      <div id="admin-bar" class="hide max-w-7xl mx-auto px-4 mt-6">
        <div class="bg-white rounded-3xl p-6 shadow-xl">
          <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2 text-indigo-900"><span>üìä</span> Dashboard & Management</h2>
            <div class="flex bg-gray-100 p-1 rounded-xl overflow-x-auto">
                <button onclick="switchAdminTab('dash')" class="admin-tab tab-active px-4 py-1 whitespace-nowrap" id="btn-dash">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                <button onclick="switchAdminTab('prod')" class="admin-tab px-4 py-1 whitespace-nowrap" id="btn-prod">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="switchAdminTab('mem')" class="admin-tab px-4 py-1 whitespace-nowrap" id="btn-mem">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
          </div>

          <div id="admin-dash" class="admin-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                <p class="font-bold mb-4 text-gray-600">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</p>
                <canvas id="salesChart" height="150"></canvas>
            </div>
            <div class="space-y-4">
                <div class="bg-indigo-600 text-white p-4 rounded-2xl shadow-lg shadow-indigo-200">
                    <p class="text-indigo-100 text-xs uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <h3 class="text-3xl font-bold" id="stat-sales">0 ‡∏ø</h3>
                </div>
                <div class="bg-white border p-4 rounded-2xl">
                    <p class="text-gray-400 text-xs">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <h3 class="text-xl font-bold text-gray-700" id="stat-prods">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                </div>
            </div>
          </div>

          <div id="admin-prod" class="admin-content hide space-y-4">
            <form onsubmit="handleAddProduct(event)" class="grid grid-cols-1 md:grid-cols-5 gap-2 bg-gray-50 p-4 rounded-2xl border">
                <input id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required class="p-2 rounded-lg border text-sm">
                <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required class="p-2 rounded-lg border text-sm">
                <input id="p-stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å" required class="p-2 rounded-lg border text-sm">
                <input id="p-icon" placeholder="Emoji (üçî)" required class="p-2 rounded-lg border text-sm text-center">
                <button class="bg-indigo-600 text-white rounded-lg font-bold text-sm py-2">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
            <div class="overflow-x-auto"><table class="w-full text-left text-sm border-collapse">
                <thead class="text-gray-400 border-b"><tr><th class="py-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="admin-prod-list" class="divide-y"></tbody>
            </table></div>
          </div>
          
          <div id="admin-mem" class="admin-content hide space-y-4">...</div>
        </div>
      </div>

      <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
      </main>

      <div id="cart-modal" class="hide fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="toggleCart()"></div>
        <div class="absolute right-0 top-0 h-full w-full max-w-sm bg-white p-6 shadow-2xl flex flex-col">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
              <button onclick="toggleCart()" class="text-gray-400 text-2xl">‚úï</button>
          </div>
          <div id="cart-items" class="flex-1 overflow-auto space-y-3"></div>
          <div class="border-t pt-6 mt-4">
            <div class="flex justify-between font-bold text-2xl mb-6"><span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span><span class="text-indigo-600" id="cart-total">0</span></div>
            <button onclick="handleCheckout()" id="btn-pay" class="w-full btn-primary text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymqDsDwWSayPwsGogUwGxxOvobyvCikp_guq6-B2t2oieilor6p3ETeTatOQYk8Psx/exec"; //
    let dbUsers = [], products = [], history = [], currentUser = null, cart = [], isReady = false;
    let salesChart = null;

    // --- Core Logic & Session ---
    function checkSession() {
        const saved = localStorage.getItem('sciShopUser');
        if (saved) {
            currentUser = JSON.parse(saved);
            fetchData();
            initShop();
        } else {
            fetchData();
        }
    }

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        dbUsers = data.users; products = data.products; history = data.history;
        isReady = true;
        if(currentUser) refreshUserData();
        renderProducts();
        renderAdminSystems();
        updateChart();
      } catch (e) { showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error"); }
    }

    // --- Product Rendering with Search & Stock ---
    function renderProducts() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(search));
      
      document.getElementById('product-grid').innerHTML = filtered.map(p => `
        <div class="card-glass rounded-2xl p-4 text-center shadow-sm hover:shadow-xl transition-all border border-white relative ${p.stock <= 0 ? 'opacity-50 grayscale' : ''}">
          ${p.stock <= 5 && p.stock > 0 ? `<span class="absolute top-2 left-2 bg-orange-500 text-white text-[8px] px-2 py-0.5 rounded-full">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î!</span>` : ''}
          <div class="text-5xl mb-3">${p.icon}</div>
          <div class="font-bold text-gray-800 truncate">${p.name}</div>
          <div class="text-indigo-600 font-bold mb-3">${p.price} ‡∏ø</div>
          <div class="text-[10px] text-gray-400 mb-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock}</div>
          <button onclick="${p.stock > 0 ? `addToCart(${p.id})` : ''}" 
            class="w-full ${p.stock > 0 ? 'bg-gray-800 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-2 rounded-xl text-xs font-bold transition-all">
            ${p.stock > 0 ? '‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' : '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î'}
          </button>
        </div>`).join('');
    }

    // --- Chart & Analytics ---
    function updateChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const last7Days = Array.from({length: 7}, (_, i) => {
            const d = new Date(); d.setDate(d.getDate() - i);
            return d.toLocaleDateString();
        }).reverse();

        const data = last7Days.map(date => {
            return history.filter(h => new Date(h.time).toLocaleDateString() === date)
                          .reduce((s, h) => s + Number(h.total), 0);
        });

        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{ label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)', data: data, borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)' }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // --- Action Handlers ---
    async function handleCheckout() {
      const total = cart.reduce((s, i) => s + Number(i.price), 0);
      if(currentUser.balance < total) return showToast("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠!", "error");
      
      // Check stock client-side first
      for(let item of cart) {
          const p = products.find(x => x.id == item.id);
          if(p.stock <= 0) return showToast(`${p.name} ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!`, "error");
      }

      const itemsStr = cart.map(i => i.name).join(', ');
      setBtn('btn-pay', true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô...");
      
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (API ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö stock)
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ 
            action: 'checkout', 
            username: currentUser.username, 
            total: total,
            items: itemsStr
        })
      });

      cart = []; updateCartUI(); toggleCart(); 
      showToast("‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"); 
      fetchData();
      setBtn('btn-pay', false, "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
    }

    // --- Helpers ---
    function logout() {
        localStorage.removeItem('sciShopUser');
        location.reload();
    }

    function showToast(m, type="success") {
      const c = document.getElementById('toast-container');
      const d = document.createElement('div');
      d.className = `toast px-6 py-4 rounded-2xl shadow-2xl text-white font-bold text-sm ${type==='success'?'bg-emerald-500':'bg-rose-500'}`;
      d.innerHTML = `<span>${type==='success'?'‚úÖ':'‚ùå'}</span> ${m}`;
      c.appendChild(d); setTimeout(()=>d.remove(), 3000);
    }

    // (Include other helper functions like handleLogin, switchAuth, renderAdminSystems... from the original code)
  </script>
</body>
</html>