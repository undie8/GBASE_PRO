<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iron Log</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #0f172a; font-family: sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        input[type=number] { -moz-appearance: textfield; }
        
        /* üü¢ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô Scrollbar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop */
        .custom-scroll { overflow-x: auto; scroll-behavior: smooth; }
        .custom-scroll::-webkit-scrollbar { height: 8px; } /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
        .custom-scroll::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.8); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .btn-action { transition: transform 0.1s; active: scale(0.95); }
        
        /* CSS ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
        .gallery-img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ */
            /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏° */
        }
    </style>
</head>
<body class="text-slate-200 font-sans min-h-screen pb-24">
    
    <div class="fixed top-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md z-50 border-b border-slate-800 h-16 shadow-lg flex items-center justify-between px-4">
        <button onclick="window.location.href='index'" class="flex items-center text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left mr-2"></i><span class="text-xs font-bold uppercase">Back</span></button>
        <h1 class="text-xl font-black bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent uppercase">IRON LOG</h1>
        <div class="w-8"></div>
    </div>

    <div class="max-w-md mx-auto pt-24 px-5">
        <div class="text-center mb-6"><p id="headerDate" class="text-xl font-bold text-white tracking-wide">...</p></div>

        <div class="flex bg-slate-800/50 p-1.5 rounded-2xl mb-6 border border-slate-700/50">
            <button onclick="switchTab('weight')" id="tabWeight" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg bg-slate-700 text-white"><i class="fas fa-weight-scale mr-2 text-orange-400"></i>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</button>
            <button onclick="switchTab('photo')" id="tabPhoto" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400">‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà</button>
        </div>

        <div id="loader" class="hidden fixed inset-0 bg-slate-900/90 z-50 flex flex-col items-center justify-center"><i class="fas fa-circle-notch fa-spin text-4xl text-green-500 mb-4"></i><p class="text-white text-xs">Processing...</p></div>

        <div id="sectionWeight" class="space-y-6">
            <div class="glass-panel p-5 rounded-3xl relative overflow-hidden">
                <p class="text-xs text-slate-400 uppercase font-bold">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p><h2 id="currentWeightDisplay" class="text-3xl font-bold text-white mt-1">--.-- kg</h2>
                <div class="h-48 w-full"><canvas id="weightChart"></canvas></div>
            </div>
            <div class="glass-panel p-4 rounded-3xl shadow-lg">
                <div class="flex gap-3 mb-4">
                    <div class="flex-1"><label class="text-[10px] text-slate-400 font-bold mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="weightDate" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-white"></div>
                    <div class="w-28"><label class="text-[10px] text-slate-400 font-bold mb-1 block">‡∏Å‡∏Å.</label><input type="number" id="weightVal" step="0.01" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-white text-center font-bold"></div>
                </div>
                <button onclick="saveWeight()" id="btnSaveWeight" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg btn-action">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div id="weightList" class="space-y-2"></div>
        </div>

        <div id="sectionPhoto" class="hidden space-y-6">
            
            <div class="glass-panel p-4 rounded-3xl border-2 border-dashed border-slate-700 relative overflow-hidden">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="previewUpload(this)">
                <input type="file" id="galleryInput" accept="image/*" class="hidden" onchange="previewUpload(this)">

                <div id="uploadPlaceholder" class="py-2">
                    <div class="text-center mb-3"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏∏‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p></div>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('cameraInput').click()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 px-4 rounded-xl flex items-center justify-center gap-2 btn-action shadow-lg shadow-blue-500/20">
                            <i class="fas fa-camera text-lg"></i><span class="text-sm font-bold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏¢</span>
                        </button>
                        <button onclick="document.getElementById('galleryInput').click()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 px-4 rounded-xl flex items-center justify-center gap-2 btn-action border border-slate-600">
                            <i class="fas fa-images text-lg text-slate-300"></i><span class="text-sm font-bold text-slate-300">‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°</span>
                        </button>
                    </div>
                </div>

                <div id="uploadPreview" class="hidden relative z-20">
                    <div class="w-full h-96 bg-slate-900/50 rounded-xl mb-3 flex items-center justify-center border border-slate-600 overflow-hidden">
                        <img id="imgPreview" class="w-full h-full object-contain">
                    </div>
                    <div class="flex gap-2 mb-3">
                        <input type="date" id="photoDate" onchange="autoFillWeight()" class="flex-1 bg-slate-800 p-3 rounded-xl text-xs text-white border border-slate-600 text-center">
                        <input type="number" id="photoWeight" placeholder="‡∏ô‡∏ô." class="w-24 bg-slate-800 p-3 rounded-xl text-xs text-white text-center border border-slate-600 font-bold">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="uploadPhoto()" id="btnUploadConfirm" class="flex-1 bg-green-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-500/30 btn-action">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button onclick="cancelUpload()" class="px-6 bg-slate-700 text-white py-3 rounded-xl text-sm btn-action">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>

            <div class="flex items-end justify-between px-2">
                <h3 class="text-xs font-bold text-slate-500 uppercase">History</h3>
                <div class="flex gap-1 items-center bg-slate-800/80 p-1 rounded-lg border border-slate-700/50">
                    <input type="date" id="galleryStart" onchange="renderGallery()" class="bg-transparent text-[10px] text-white w-20 text-center outline-none">
                    <span class="text-[10px] text-slate-500">-</span>
                    <input type="date" id="galleryEnd" onchange="renderGallery()" class="bg-transparent text-[10px] text-white w-20 text-center outline-none">
                </div>
            </div>

            <div id="galleryGrid" class="flex overflow-x-auto gap-4 pb-6 px-1 custom-scroll"></div>
        </div>
    </div>

    <script>
        const API_URL = CONFIG.SCRIPT_URL; const CACHE_KEY = 'iron_log_data'; const TAB_KEY = 'iron_log_active_tab';
        let globalWeights = []; let globalGallery = []; let chartInstance = null;
        const THAI_MONTHS_FULL = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        
        function getLocalISODate(off = 0) { const d = new Date(); d.setDate(d.getDate() + off); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function updateHeaderDate() { const d = new Date(); document.getElementById('headerDate').innerText = `${d.getDate()} ${THAI_MONTHS_FULL[d.getMonth()]} ${d.getFullYear()+543}`; }
        
        window.onload = function() { 
            updateHeaderDate(); 
            document.getElementById('weightDate').value = getLocalISODate(); 
            document.getElementById('photoDate').value = getLocalISODate(); 
            document.getElementById('galleryStart').value = getLocalISODate(-30); 
            document.getElementById('galleryEnd').value = getLocalISODate(); 
            switchTab(localStorage.getItem(TAB_KEY) || 'weight'); 
            const c = localStorage.getItem(CACHE_KEY); 
            if (c) { try { processAndRender(JSON.parse(c)); fetchData(true); } catch(e) { fetchData(false); } } else { fetchData(false); } 
        };

        async function fetchData(bg) { 
            if(!bg) document.getElementById('loader').classList.remove('hidden'); 
            try { const r = await fetch(`${API_URL}?get=fitnessData&t=${Date.now()}`); const d = await r.json(); localStorage.setItem(CACHE_KEY, JSON.stringify(d)); processAndRender(d); } catch (e) {} finally { document.getElementById('loader').classList.add('hidden'); } 
        }

        function processAndRender(d) { globalWeights = d.weights || []; globalGallery = d.gallery || []; renderWeightList(); renderChart(); renderGallery(); if (globalWeights.length > 0) { document.getElementById('currentWeightDisplay').innerHTML = `${parseFloat(globalWeights[0].value).toFixed(2)} kg`; autoFillWeight(); } }
        function autoFillWeight() { const sel = document.getElementById('photoDate').value; const r = globalWeights.find(w => { const d = new Date(w.date); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` === sel; }); document.getElementById('photoWeight').value = r ? r.value : ''; }
        
        function renderWeightList() { 
            const l = document.getElementById('weightList'); l.innerHTML = ''; 
            if (!globalWeights.length) return; 
            globalWeights.forEach((it, idx) => { 
                let diff = ''; if (idx < globalWeights.length - 1) { const d = parseFloat(it.value) - parseFloat(globalWeights[idx+1].value); diff = `<span class="text-[10px] ml-2 px-1.5 py-0.5 rounded ${d>0?'text-red-400 bg-red-400/10':'text-green-400 bg-green-400/10'}">${d>0?'+':''}${d.toFixed(2)}</span>`; } 
                l.innerHTML += `<div class="glass-panel px-4 py-3 rounded-xl flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-900 flex items-center justify-center text-orange-400 font-bold">${parseFloat(it.value).toFixed(1)}</div><span class="text-sm font-bold text-slate-200">${formatDate(it.date)}</span></div><div class="flex items-center">${diff}<button onclick="deleteWeight('${it.date}')" class="ml-2 text-slate-600 hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button></div></div>`; 
            }); 
        }
        
        function renderGallery() { 
            const g = document.getElementById('galleryGrid'); g.innerHTML = ''; 
            const st = new Date(document.getElementById('galleryStart').value); const en = new Date(document.getElementById('galleryEnd').value); en.setHours(23,59,59); 
            let f = globalGallery.filter(i => { const d = new Date(i.date); return d >= st && d <= en; }).sort((a,b) => new Date(a.date) - new Date(b.date)); 
            if (!f.length) { g.innerHTML = '<div class="w-full text-center text-slate-600 py-10"><i class="fas fa-images text-3xl mb-2"></i><p class="text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</p></div>'; return; } 
            
            f.forEach(i => { 
                const w = i.weight ? `<div class="absolute top-3 right-3 bg-black/70 px-2 py-1 rounded-lg text-xs font-bold text-white border border-white/10 shadow-lg backdrop-blur-sm">${i.weight} kg</div>` : ''; 
                const highResUrl = `https://drive.google.com/thumbnail?id=${i.fileId}&sz=w1000`;
                
                g.innerHTML += `
                <div class="glass-panel rounded-2xl overflow-hidden relative group min-w-[85%] snap-center shadow-xl">
                    <div class="relative h-[450px] bg-slate-900">
                        <img src="${highResUrl}" class="gallery-img" loading="lazy" onerror="this.src='${i.url}'">
                        ${w}
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-900/90 pt-16 flex justify-between items-end">
                            <div><p class="text-[10px] text-slate-400 uppercase font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</p><p class="text-lg font-bold text-white">${formatDate(i.date)}</p></div>
                            <button onclick="deletePhoto('${i.fileId}')" class="w-10 h-10 rounded-full bg-black/40 text-white flex items-center justify-center transition border border-white/10"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>`; 
            }); 
            // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö scroll ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏´‡πá‡∏ô scrollbar ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
        }
        
        function renderChart() { 
            const ctx = document.getElementById('weightChart').getContext('2d'); const d = [...globalWeights].slice(0, 10).reverse(); 
            if (chartInstance) chartInstance.destroy(); 
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: d.map(x => { const dt = new Date(x.date); return `${dt.getDate()}/${dt.getMonth()+1}`; }), datasets: [{ data: d.map(x => x.value), borderColor: '#f97316', borderWidth: 2, tension: 0.4, pointBackgroundColor: '#f97316', fill: true, backgroundColor: 'rgba(249, 115, 22, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#94a3b8', font:{size:10} }, grid: {display:false} } } } }); 
        }

        function switchTab(t) { 
            localStorage.setItem(TAB_KEY, t); 
            const wS = document.getElementById('sectionWeight'); const pS = document.getElementById('sectionPhoto'); 
            const wT = document.getElementById('tabWeight'); const pT = document.getElementById('tabPhoto'); 
            if (t === 'weight') { wS.classList.remove('hidden'); pS.classList.add('hidden'); wT.className = "flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg bg-slate-700 text-white"; pT.className = "flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400"; renderChart(); } 
            else { wS.classList.add('hidden'); pS.classList.remove('hidden'); pT.className = "flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg bg-slate-700 text-white"; wT.className = "flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400"; renderGallery(); } 
        }

        let currentFile = null;
        function previewUpload(input) { 
            if (input.files && input.files[0]) { 
                currentFile = input.files[0];
                const r = new FileReader(); 
                r.onload = (e) => { 
                    document.getElementById('imgPreview').src = e.target.result; 
                    document.getElementById('uploadPlaceholder').classList.add('hidden'); 
                    document.getElementById('uploadPreview').classList.remove('hidden'); 
                    autoFillWeight(); 
                }; 
                r.readAsDataURL(input.files[0]); 
            } 
        }

        function cancelUpload() { 
            document.getElementById('cameraInput').value = ''; 
            document.getElementById('galleryInput').value = ''; 
            currentFile = null;
            document.getElementById('uploadPlaceholder').classList.remove('hidden'); 
            document.getElementById('uploadPreview').classList.add('hidden'); 
        }

        async function saveWeight() { 
            const b = document.getElementById('btnSaveWeight'); b.disabled = true; 
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveWeight', date: document.getElementById('weightDate').value, weight: document.getElementById('weightVal').value }) }); fetchData(true); Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', toast:true, position:'top', timer:1000, showConfirmButton:false});} catch(e) {} finally { b.disabled = false; } 
        }

        async function uploadPhoto() { 
            if(!currentFile) return;
            const b = document.getElementById('btnUploadConfirm'); b.disabled = true; b.innerText = 'Uploading...';
            const r = new FileReader(); 
            r.onload = async (e) => { 
                try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'uploadPhoto', date: document.getElementById('photoDate').value, weight: document.getElementById('photoWeight').value, image: e.target.result }) }); cancelUpload(); fetchData(true); Swal.fire({icon:'success', title:'‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', toast:true, position:'top', timer:1000, showConfirmButton:false}); } catch(err) { Swal.fire('Error', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); } finally { b.disabled = false; b.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; } 
            }; 
            r.readAsDataURL(currentFile); 
        }

        async function deletePhoto(id) { const rs = await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏π‡∏õ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', background:'#1e293b', color:'#fff' }); if (rs.isConfirmed) { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'deletePhoto', fileId: id }) }); fetchData(true); } }
        async function deleteWeight(d) { const rs = await Swal.fire({ title: '‡∏•‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å?', icon: 'warning', showCancelButton: true, background:'#1e293b', color:'#fff' }); if (rs.isConfirmed) { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteWeight', date: d }) }); fetchData(true); } }
        function formatDate(d) { return new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }); }
    </script>
</body>
</html>
